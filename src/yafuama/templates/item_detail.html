{% extends "base.html" %}
{% block title %}{{ item.title or item.auction_id }} - ヤフアマ{% endblock %}

{% block content %}
<div class="mb-4">
  <a href="/items" class="text-sm text-blue-600 hover:underline">&larr; 出品モニタリングに戻る</a>
</div>

{% set yahoo_labels = {"active": "ヤフオク出品中", "ended_sold": "落札済", "ended_no_winner": "終了"} %}
{% set cond_labels = {"used_like_new": "ほぼ新品", "used_very_good": "非常に良い", "used_good": "良い", "used_acceptable": "可"} %}
{% set pattern_labels = {"1_2_days": "1〜2日で発送", "2_3_days": "2〜3日で発送", "3_7_days": "3〜7日で発送"} %}

<div class="grid lg:grid-cols-3 gap-4">
  <!-- Main info -->
  <div class="lg:col-span-2 space-y-4">
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <div class="flex gap-4">
        {% if item.image_url %}
        <img src="{{ item.image_url }}" alt="" class="w-24 h-24 object-cover rounded flex-shrink-0">
        {% endif %}
        <div class="min-w-0">
          <h1 class="text-lg font-bold text-gray-900">{{ item.title or item.auction_id }}</h1>
          <div class="mt-1 flex items-center gap-2 text-sm">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium
              {% if item.status == 'active' %}bg-green-100 text-green-700
              {% elif item.status == 'ended_sold' %}bg-blue-100 text-blue-700
              {% else %}bg-gray-100 text-gray-600{% endif %}">{{ yahoo_labels.get(item.status, item.status) }}</span>
            {% if item.amazon_listing_status == 'active' %}
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">Amazon出品中</span>
            {% elif item.amazon_listing_status == 'delisted' %}
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700">Amazon取下げ</span>
            {% elif item.amazon_listing_status == 'error' %}
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">Amazonエラー</span>
            {% endif %}
            <a href="{{ item.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">ヤフオクページ &rarr;</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Price info -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-3">価格情報</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
        <div>
          <div class="text-gray-500 text-xs">現在価格</div>
          <div class="font-semibold">&yen;{{ "{:,}".format(item.current_price) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">開始価格</div>
          <div>&yen;{{ "{:,}".format(item.start_price) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">即決価格</div>
          <div>{% if item.buy_now_price %}&yen;{{ "{:,}".format(item.buy_now_price) }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">入札数</div>
          <div>{{ item.bid_count }}</div>
        </div>
      </div>
    </div>

    <!-- Amazon info -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-3">Amazon出品情報</h2>

      {% if item.amazon_asin %}
      {# --- 利益計算 --- #}
      {% set yahoo_cost = item.estimated_win_price or item.current_price %}
      {% set yahoo_ship = item.shipping_cost %}
      {% set fwd_cost = item.forwarding_cost %}
      {% set sys_fee = 100 %}
      {% set fee_pct = item.amazon_fee_pct %}
      {% set sell_price = item.amazon_price or 0 %}
      {% set amazon_fee = (sell_price * fee_pct / 100)|round|int %}
      {% set total_cost = yahoo_cost + yahoo_ship + fwd_cost + sys_fee + amazon_fee %}
      {% set gross_profit = sell_price - total_cost %}
      {% set margin_pct = ((gross_profit / sell_price * 100)|round(1)) if sell_price > 0 else 0 %}

      {# --- 商品情報 --- #}
      <div class="mb-4">
        <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">商品情報</div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
          <div>
            <div class="text-gray-500 text-xs">ASIN</div>
            <a href="https://amazon.co.jp/dp/{{ item.amazon_asin }}" target="_blank"
               class="font-mono text-xs text-blue-600 hover:underline">{{ item.amazon_asin }}</a>
          </div>
          <div>
            <div class="text-gray-500 text-xs">SKU</div>
            <div class="font-mono text-xs">{{ item.amazon_sku or "-" }}</div>
          </div>
          <div>
            <div class="text-gray-500 text-xs">コンディション</div>
            <div class="text-xs">{{ cond_labels.get(item.amazon_condition, item.amazon_condition) }}</div>
          </div>
          <div>
            <div class="text-gray-500 text-xs">出品ステータス</div>
            <div>
              {% if item.amazon_listing_status == 'active' %}
              <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs">出品中</span>
              {% elif item.amazon_listing_status == 'delisted' %}
              <span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-xs">取り下げ済み</span>
              {% elif item.amazon_listing_status %}
              <span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">{{ item.amazon_listing_status }}</span>
              {% else %}-{% endif %}
            </div>
          </div>
        </div>
      </div>

      {# --- コスト・利益 --- #}
      <div class="mb-4 p-3 rounded-lg {% if gross_profit > 0 %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
        <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">コスト・利益</div>
        <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-sm">
          {# 左列: 仕入れ #}
          <div>
            <div class="text-gray-500 text-[10px]">仕入れ</div>
            <div class="font-semibold">&yen;{{ "{:,}".format(yahoo_cost) }}</div>
          </div>
          {# 中央列: Amazon売価 #}
          <div>
            <div class="text-gray-500 text-[10px]">Amazon売価</div>
            <div class="flex items-center gap-1">
              <span id="price-display" class="font-semibold text-purple-700">&yen;{{ "{:,}".format(sell_price) }}</span>
              {% if item.amazon_sku or item.amazon_listing_status == 'delisted' %}
              <button onclick="showPriceEdit()" id="price-edit-btn" class="text-[10px] text-gray-400 hover:text-blue-600" title="価格変更">&#9998;</button>
              {% endif %}
            </div>
            <div id="price-edit-form" class="hidden mt-1">
              <div class="flex items-center gap-1">
                <input type="number" id="new-price" value="{{ sell_price }}" min="1" class="w-24 px-1.5 py-0.5 text-xs border rounded">
                <button onclick="updatePrice()" class="px-1.5 py-0.5 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700">変更</button>
                <button onclick="hidePriceEdit()" class="px-1.5 py-0.5 text-[10px] bg-gray-100 rounded hover:bg-gray-200">取消</button>
              </div>
              <div id="price-msg" class="text-[10px] mt-0.5"></div>
            </div>
          </div>
          {# 右列: 粗利 #}
          <div>
            <div class="text-gray-500 text-[10px]">粗利</div>
            <div class="font-bold text-lg {% if gross_profit > 0 %}text-green-700{% else %}text-red-600{% endif %}">
              &yen;{{ "{:,}".format(gross_profit) }}
              <span class="text-xs font-normal">({{ margin_pct }}%)</span>
            </div>
          </div>
        </div>
        {# コスト内訳 #}
        <div class="mt-2 pt-2 border-t {% if gross_profit > 0 %}border-green-200{% else %}border-red-200{% endif %}">
          <div class="flex flex-wrap gap-x-4 gap-y-0.5 text-xs text-gray-500">
            <span>Yahoo送料 &yen;{{ "{:,}".format(yahoo_ship) }}</span>
            <span>転送費 &yen;{{ "{:,}".format(fwd_cost) }}</span>
            <span>利用料 &yen;{{ "{:,}".format(sys_fee) }}</span>
            <span>Amazon手数料({{ fee_pct }}%) &yen;{{ "{:,}".format(amazon_fee) }}</span>
          </div>
          <div class="text-[10px] text-gray-400 mt-1">
            総コスト &yen;{{ "{:,}".format(total_cost) }} = 仕入れ + 送料 + 転送 + 利用料 + 手数料
          </div>
        </div>
      </div>

      {# --- 配送設定 --- #}
      <div>
        <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">配送設定</div>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
          <div>
            <div class="text-gray-500 text-xs">配送パターン</div>
            <div class="text-xs">{{ pattern_labels.get(item.amazon_shipping_pattern, "-") }}</div>
          </div>
          <div>
            <div class="text-gray-500 text-xs">リードタイム</div>
            <div>{{ item.amazon_lead_time_days }}日</div>
          </div>
          <div>
            <div class="text-gray-500 text-xs">最終同期</div>
            <div class="text-xs">{{ item.amazon_last_synced_at.strftime('%m/%d %H:%M') if item.amazon_last_synced_at else "-" }}</div>
          </div>
        </div>
      </div>

      {# --- セラセン確認チェックリスト --- #}
      {% if item.amazon_listing_status == 'active' %}
      <div x-data="checklistPanel()" x-init="init()">
        <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">セラセン確認チェックリスト</div>
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm cursor-pointer group border-b border-gray-100 pb-2 mb-1">
            <input type="checkbox" :checked="checkedCount === totalCount" @change="checkAll($event.target.checked)"
                   class="rounded border-gray-300 text-green-600 focus:ring-green-500">
            <span class="font-medium" :class="checkedCount === totalCount ? 'text-green-600' : 'text-gray-700'">
              すべてOK
            </span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer group">
            <input type="checkbox" x-model="checklist.lead_time" @change="save('lead_time')"
                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span :class="checklist.lead_time ? 'text-gray-400 line-through' : 'text-gray-700'">
              リードタイム（出荷準備日数）を設定
            </span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer group">
            <input type="checkbox" x-model="checklist.images" @change="save('images')"
                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span :class="checklist.images ? 'text-gray-400 line-through' : 'text-gray-700'">
              画像が正しく表示されている
            </span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer group">
            <input type="checkbox" x-model="checklist.condition" @change="save('condition')"
                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span :class="checklist.condition ? 'text-gray-400 line-through' : 'text-gray-700'">
              コンディション説明が正しい
            </span>
          </label>
        </div>
        <div class="mt-2 text-xs text-gray-400">
          <span x-text="checkedCount"></span>/<span x-text="totalCount"></span> 確認済み
          <template x-if="checkedCount === totalCount">
            <span class="ml-1 text-green-600 font-medium">完了</span>
          </template>
        </div>
      </div>
      {% endif %}

      {% else %}
      <p class="text-sm text-gray-500">Amazon未出品。キーワードページのDealAlertから出品できます。</p>
      {% endif %}
    </div>

    <!-- Keepa analysis -->
    {% if item.amazon_asin %}
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-900">Keepa分析</h2>
        <button hx-get="/partials/keepa-inline/{{ item.amazon_asin }}?cost_price={{ item.estimated_win_price or item.current_price }}&shipping_cost={{ item.shipping_cost }}"
                hx-target="#keepa-inline-result" hx-indicator="#keepa-spinner"
                class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">
          分析する
          <span id="keepa-spinner" class="htmx-indicator spinner inline-block w-3 h-3 border-2 border-gray-300 border-t-blue-600 rounded-full ml-1"></span>
        </button>
      </div>
      <div id="keepa-inline-result">
        <p class="text-xs text-gray-500">「分析する」をクリックして {{ item.amazon_asin }} のKeepaデータを取得します</p>
      </div>
    </div>
    {% endif %}

    <!-- Tabs: History / Notifications -->
    <div class="bg-white rounded-lg shadow-sm border" x-data="{ tab: 'history' }">
      <div class="flex border-b">
        <button @click="tab = 'history'" :class="tab === 'history' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'"
                class="px-4 py-2 text-sm font-medium">履歴</button>
        <button @click="tab = 'notifications'" :class="tab === 'notifications' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'"
                class="px-4 py-2 text-sm font-medium">通知ログ</button>
      </div>

      <!-- History tab -->
      <div x-show="tab === 'history'" class="p-4">
        {% set change_labels = {
          "status_change": "ステータス変更", "price_change": "価格変更", "bid_change": "入札変更",
          "initial": "監視開始", "amazon_listing": "Amazon出品", "amazon_delist": "Amazon取下げ",
          "amazon_delist_auto": "Amazon自動取下げ", "amazon_error": "Amazonエラー"
        } %}
        {% set change_colors = {
          "amazon_listing": "bg-purple-100 text-purple-700",
          "amazon_delist": "bg-orange-100 text-orange-700",
          "amazon_delist_auto": "bg-orange-100 text-orange-700",
          "amazon_error": "bg-red-100 text-red-700"
        } %}
        <div class="space-y-2">
          {% for h in history %}
          <div class="flex items-center text-xs text-gray-600 gap-2">
            <span class="text-gray-400 w-32 flex-shrink-0">{{ h.recorded_at.strftime('%m/%d %H:%M') if h.recorded_at else '' }}</span>
            <span class="px-1.5 py-0.5 rounded font-medium {{ change_colors.get(h.change_type, 'bg-gray-100') }}">{{ change_labels.get(h.change_type, h.change_type) }}</span>
            {% if h.change_type == 'status_change' %}
            <span>{{ h.old_status }} &rarr; {{ h.new_status }}</span>
            {% elif h.change_type == 'price_change' %}
            <span>&yen;{{ "{:,}".format(h.old_price or 0) }} &rarr; &yen;{{ "{:,}".format(h.new_price or 0) }}</span>
            {% elif h.change_type == 'bid_change' %}
            <span>{{ h.old_bid_count or 0 }} &rarr; {{ h.new_bid_count or 0 }}件</span>
            {% elif h.change_type == 'initial' %}
            <span>監視を開始しました</span>
            {% elif h.change_type == 'amazon_listing' %}
            <span>SKU: {{ h.new_status or '-' }} でAmazonに出品</span>
            {% elif h.change_type in ('amazon_delist', 'amazon_delist_auto') %}
            <span>SKU: {{ h.old_status or '-' }} をAmazonから取り下げ</span>
            {% elif h.change_type == 'amazon_error' %}
            <span>{{ h.new_status or 'エラー' }}</span>
            {% endif %}
          </div>
          {% else %}
          <p class="text-xs text-gray-500">履歴はまだありません。</p>
          {% endfor %}
        </div>
      </div>

      <!-- Notifications tab -->
      <div x-show="tab === 'notifications'" x-cloak class="p-4">
        <div class="space-y-2">
          {% for n in notifications %}
          <div class="flex items-center text-xs text-gray-600 gap-2">
            <span class="text-gray-400 w-32 flex-shrink-0">{{ n.sent_at.strftime('%m/%d %H:%M') if n.sent_at else '' }}</span>
            <span class="px-1.5 py-0.5 rounded font-medium
              {% if n.success %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-600{% endif %}">
              {{ n.channel }}
            </span>
            <span class="px-1.5 py-0.5 rounded bg-gray-100 font-medium">{{ n.event_type }}</span>
            <span class="truncate">{{ n.message }}</span>
          </div>
          {% else %}
          <p class="text-xs text-gray-500">通知履歴はまだありません。</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar actions -->
  <div class="space-y-4">
    <div class="bg-white rounded-lg shadow-sm border p-4 space-y-3">
      <h2 class="text-sm font-semibold text-gray-900">操作</h2>
      <button hx-post="/api/items/{{ item.auction_id }}/refresh" hx-swap="none"
              hx-on::after-request="if(event.detail.successful) window.location.reload()"
              class="w-full px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-md text-center">
        データを更新
      </button>
      {% if item.amazon_sku %}
      <button onclick="delistAmazon()" id="delist-btn"
              class="w-full px-3 py-2 text-sm bg-orange-50 text-orange-600 hover:bg-orange-100 rounded-md text-center">
        Amazon出品のみ取り下げ
      </button>
      {% elif item.amazon_asin and item.amazon_listing_status == 'delisted' %}
      <div class="space-y-2">
        <label class="block text-xs text-gray-500">コンディション</label>
        <select id="relist-condition" class="w-full px-2 py-1.5 text-sm border rounded-md" onchange="onRelistConditionChange()">
          {% for val, label in [("used_like_new", "ほぼ新品"), ("used_very_good", "非常に良い"), ("used_good", "良い"), ("used_acceptable", "可")] %}
          <option value="{{ val }}" {% if item.amazon_condition == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <label class="block text-xs text-gray-500">コンディションノート</label>
        <textarea id="relist-condition-note" rows="3"
                  class="w-full px-2 py-1.5 text-sm border rounded-md"
                  placeholder="コンディション説明...">{{ item.amazon_condition_note or '' }}</textarea>
        <!-- Image selection for relist -->
        <label class="block text-xs text-gray-500">画像選択</label>
        <div id="relist-images-container">
          <div id="relist-images-loading" class="text-xs text-gray-400 py-2 text-center">画像を読み込み中...</div>
          <div id="relist-images-grid" class="grid grid-cols-3 gap-1.5 hidden"></div>
          <div id="relist-images-empty" class="text-xs text-gray-400 py-2 text-center hidden">画像が見つかりません</div>
        </div>
        <div class="text-[10px] text-gray-400">最大6枚選択（1枚目がメイン画像）</div>
        <button onclick="relistAmazon()" id="relist-btn"
                class="w-full px-3 py-2 text-sm bg-purple-50 text-purple-700 hover:bg-purple-100 rounded-md text-center">
          Amazonに再出品
        </button>
      </div>
      {% endif %}
      <button onclick="deleteItem()" id="delete-item-btn"
              class="w-full px-3 py-2 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded-md text-center">
        {% if item.amazon_sku %}商品データごと削除{% else %}削除{% endif %}
      </button>
      <div id="delete-item-msg" class="text-xs mt-1"></div>
    </div>

    <!-- Item settings -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-2">設定</h2>
      <form onsubmit="updateSettings(event)" class="space-y-2">
        <div>
          <label class="block text-xs text-gray-500 mb-0.5">チェック間隔（秒）</label>
          <input type="number" id="set-interval" value="{{ item.check_interval_seconds }}" min="30"
                 class="w-full px-2 py-1 border rounded text-sm">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-0.5">メモ</label>
          <input type="text" id="set-notes" value="{{ item.notes }}"
                 class="w-full px-2 py-1 border rounded text-sm">
        </div>
        <button type="submit" class="w-full px-2 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">
          設定を保存
        </button>
        <div id="settings-msg" class="text-xs"></div>
      </form>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-2">詳細情報</h2>
      <dl class="text-xs space-y-2">
        <div><dt class="text-gray-500">オークションID</dt><dd class="font-mono">{{ item.auction_id }}</dd></div>
        <div><dt class="text-gray-500">出品者</dt><dd>{{ item.seller_id or "-" }}</dd></div>
        <div><dt class="text-gray-500">カテゴリ</dt><dd>{{ item.category_id or "-" }}</dd></div>
        <div><dt class="text-gray-500">終了日時</dt><dd>{{ item.end_time.strftime('%Y-%m-%d %H:%M') if item.end_time else "-" }}</dd></div>
        <div><dt class="text-gray-500">最終チェック</dt><dd>{{ item.last_checked_at.strftime('%m/%d %H:%M') if item.last_checked_at else "-" }}</dd></div>
        <div><dt class="text-gray-500">登録日</dt><dd>{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else "-" }}</dd></div>
      </dl>
    </div>
  </div>
</div>

<script>
const auctionId = '{{ item.auction_id }}';
const initialChecklist = {{ checklist_json|safe }};

function checklistPanel() {
  return {
    checklist: { lead_time: false, images: false, condition: false },
    get checkedCount() { return Object.values(this.checklist).filter(Boolean).length; },
    get totalCount() { return Object.keys(this.checklist).length; },
    init() {
      Object.assign(this.checklist, initialChecklist);
    },
    async save(key) {
      const payload = {};
      payload[key] = this.checklist[key];
      await fetch('/api/items/' + auctionId + '/checklist', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
    },
    async checkAll(checked) {
      this.checklist.lead_time = checked;
      this.checklist.images = checked;
      this.checklist.condition = checked;
      await fetch('/api/items/' + auctionId + '/checklist', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(this.checklist),
      });
    }
  };
}

let _relistTemplateCache = null;

async function _loadRelistTemplates() {
  if (_relistTemplateCache) return;
  try {
    const resp = await fetch('/api/templates');
    if (resp.ok) _relistTemplateCache = await resp.json();
    else _relistTemplateCache = {};
  } catch (_) { _relistTemplateCache = {}; }
}

async function onRelistConditionChange() {
  await _loadRelistTemplates();
  const condition = document.getElementById('relist-condition').value;
  const tpl = _relistTemplateCache[condition];
  if (tpl && tpl.body) {
    document.getElementById('relist-condition-note').value = tpl.body;
  }
}

// Load template on page load for pre-selected condition
(async () => {
  const condSelect = document.getElementById('relist-condition');
  if (condSelect && !document.getElementById('relist-condition-note').value.trim()) {
    await _loadRelistTemplates();
    const tpl = _relistTemplateCache?.[condSelect.value];
    if (tpl && tpl.body) {
      document.getElementById('relist-condition-note').value = tpl.body;
    }
  }
})();

// --- Relist Image Gallery ---
async function _loadRelistImages() {
  const loading = document.getElementById('relist-images-loading');
  const grid = document.getElementById('relist-images-grid');
  const empty = document.getElementById('relist-images-empty');
  if (!loading) return; // not in relist mode

  try {
    const resp = await fetch('/api/items/' + auctionId + '/images');
    if (!resp.ok) throw new Error('Failed');
    const data = await resp.json();
    const images = data.images || [];

    loading.classList.add('hidden');
    if (images.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    images.forEach((url, i) => {
      const label = document.createElement('label');
      label.className = 'relative cursor-pointer group';
      const escaped = url.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
      label.innerHTML =
        '<input type="checkbox" ' + (i === 0 ? 'checked' : '') + ' data-url="' + escaped + '"' +
        ' class="absolute top-1 left-1 z-10 rounded text-blue-600" onchange="_enforceRelistMax()">' +
        '<img src="' + escaped + '" alt="Image ' + (i+1) + '"' +
        ' class="w-full aspect-square object-cover rounded border-2 ' + (i === 0 ? 'border-blue-500' : 'border-gray-200') + ' group-hover:border-blue-400 bg-gray-100"' +
        ' onerror="this.parentElement.style.display=\'none\'">' +
        (i === 0 ? '<span class="absolute bottom-0 left-0 right-0 text-center text-[9px] bg-blue-600 text-white rounded-b">メイン</span>' : '');
      grid.appendChild(label);
    });
    grid.classList.remove('hidden');
  } catch (e) {
    loading.classList.add('hidden');
    empty.textContent = '画像の読み込みに失敗しました';
    empty.classList.remove('hidden');
  }
}

function _enforceRelistMax() {
  const checkboxes = document.querySelectorAll('#relist-images-grid input[type="checkbox"]');
  const checked = document.querySelectorAll('#relist-images-grid input[type="checkbox"]:checked');
  if (checked.length >= 6) {
    checkboxes.forEach(cb => { if (!cb.checked) cb.disabled = true; });
  } else {
    checkboxes.forEach(cb => { cb.disabled = false; });
  }
  checkboxes.forEach(cb => {
    const img = cb.parentElement.querySelector('img');
    if (img) {
      img.classList.toggle('border-blue-500', cb.checked);
      img.classList.toggle('border-gray-200', !cb.checked);
    }
  });
}

function _getSelectedRelistImages() {
  const checked = document.querySelectorAll('#relist-images-grid input[type="checkbox"]:checked');
  return Array.from(checked).map(cb => cb.dataset.url);
}

// Auto-load images on page load (only when relist UI is visible)
_loadRelistImages();

async function relistAmazon() {
  const condition = document.getElementById('relist-condition').value;
  const conditionNote = document.getElementById('relist-condition-note').value.trim();
  const imageUrls = _getSelectedRelistImages();
  const labels = {used_like_new:'ほぼ新品', used_very_good:'非常に良い', used_good:'良い', used_acceptable:'可'};
  const imgMsg = imageUrls.length > 0 ? '（画像' + imageUrls.length + '枚）' : '（画像なし）';
  if (!confirm('コンディション「' + labels[condition] + '」' + imgMsg + 'でAmazonに再出品しますか？')) return;

  const btn = document.getElementById('relist-btn');
  const msgEl = document.getElementById('delete-item-msg');
  btn.disabled = true; btn.textContent = '再出品中...';
  try {
    const body = {condition: condition};
    if (conditionNote) body.condition_note = conditionNote;
    if (imageUrls.length > 0) body.image_urls = imageUrls;
    const resp = await fetch('/api/amazon/listings/' + auctionId + '/relist', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    const d = await resp.json();
    if (!resp.ok) throw new Error(d.detail || '再出品に失敗しました');
    msgEl.textContent = '再出品しました (SKU: ' + d.amazon_sku + ')';
    msgEl.className = 'text-xs mt-1 text-green-600';
    setTimeout(() => window.location.reload(), 1000);
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-1 text-red-600';
    btn.disabled = false;
    btn.textContent = 'Amazonに再出品';
  }
}

async function delistAmazon() {
  if (!confirm('Amazon出品を取り下げますか？（商品データは残ります）')) return;

  const btn = document.getElementById('delist-btn');
  const msgEl = document.getElementById('delete-item-msg');
  btn.disabled = true; btn.textContent = '取り下げ中...';
  try {
    const resp = await fetch('/api/amazon/listings/' + auctionId, {method: 'DELETE'});
    if (!resp.ok && resp.status !== 204) {
      const d = await resp.json();
      throw new Error(d.detail || '取り下げに失敗しました');
    }
    msgEl.textContent = 'Amazon出品を取り下げました';
    msgEl.className = 'text-xs mt-1 text-green-600';
    setTimeout(() => window.location.reload(), 1000);
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-1 text-red-600';
    btn.disabled = false;
    btn.textContent = 'Amazon出品のみ取り下げ';
  }
}

async function deleteItem() {
  const hasAmazon = '{{ item.amazon_sku or "" }}' !== '';
  const msg = hasAmazon
    ? 'Amazon出品を取り下げて、商品データも完全に削除しますか？'
    : 'この商品と履歴をすべて削除しますか？';
  if (!confirm(msg)) return;

  const btn = document.getElementById('delete-item-btn');
  const msgEl = document.getElementById('delete-item-msg');
  btn.disabled = true; btn.textContent = hasAmazon ? '取り下げ中...' : '削除中...';
  try {
    const resp = await fetch('/api/items/' + auctionId, {method: 'DELETE'});
    if (!resp.ok && resp.status !== 204) {
      const d = await resp.json();
      throw new Error(d.detail || '失敗しました');
    }
    window.location = '/items';
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-1 text-red-600';
    btn.disabled = false;
    btn.textContent = hasAmazon ? '商品データごと削除' : '削除';
  }
}

function showPriceEdit() {
  document.getElementById('price-edit-form').classList.remove('hidden');
  document.getElementById('price-edit-btn').classList.add('hidden');
  document.getElementById('new-price').focus();
}
function hidePriceEdit() {
  document.getElementById('price-edit-form').classList.add('hidden');
  document.getElementById('price-edit-btn').classList.remove('hidden');
  document.getElementById('price-msg').textContent = '';
}
async function updatePrice() {
  const price = parseInt(document.getElementById('new-price').value);
  const msgEl = document.getElementById('price-msg');
  if (!price || price <= 0) { msgEl.textContent = '正しい価格を入力'; msgEl.className = 'text-[10px] mt-0.5 text-red-600'; return; }
  try {
    const resp = await fetch('/api/amazon/listings/' + auctionId + '/price', {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({price: price}),
    });
    const d = await resp.json();
    if (!resp.ok) throw new Error(d.detail || '価格変更に失敗');
    document.getElementById('price-display').textContent = '¥' + price.toLocaleString();
    msgEl.textContent = '価格を変更しました'; msgEl.className = 'text-[10px] mt-0.5 text-green-600';
    setTimeout(() => window.location.reload(), 1500);
  } catch(e) {
    msgEl.textContent = e.message; msgEl.className = 'text-[10px] mt-0.5 text-red-600';
  }
}

async function updateSettings(e) {
  e.preventDefault();
  const interval = parseInt(document.getElementById('set-interval').value);
  const notes = document.getElementById('set-notes').value;
  const msgEl = document.getElementById('settings-msg');
  try {
    const resp = await fetch('/api/items/' + auctionId, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({check_interval_seconds: interval, notes: notes})
    });
    if (!resp.ok) throw new Error('失敗しました');
    msgEl.textContent = '保存しました'; msgEl.className = 'text-xs text-green-600';
  } catch(e) {
    msgEl.textContent = e.message; msgEl.className = 'text-xs text-red-600';
  }
}

</script>
{% endblock %}
