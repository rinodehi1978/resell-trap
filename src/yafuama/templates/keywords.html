{% extends "base.html" %}
{% block title %}オートスキャン - ヤフアマ{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-xl font-bold text-gray-900">オートスキャン</h1>
    <p class="text-sm text-gray-500 mt-1">キーワードを登録すると自動で定期検索し、条件を満たすDealをDiscord/LINEに通知します。</p>
  </div>
  {% if scanner_available %}
  <button onclick="scanAll()" id="scan-all-btn"
          class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
    全キーワードをスキャン
  </button>
  {% else %}
  <span class="text-xs text-gray-400">Keepa APIが未設定のためスキャン不可</span>
  {% endif %}
</div>

<!-- AI Discovery panel -->
{% if discovery_available %}
<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg shadow-sm border border-purple-200 p-4 mb-4">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2">
      <span class="text-purple-600 font-bold text-sm">AIキーワード発見</span>
      {% if discovery_available %}
      <span class="px-1.5 py-0.5 text-[10px] bg-green-100 text-green-700 rounded-full">稼働中</span>
      {% else %}
      <span class="px-1.5 py-0.5 text-[10px] bg-gray-100 text-gray-500 rounded-full">停止</span>
      {% endif %}
    </div>
    {% if discovery_available %}
    <button onclick="triggerDiscovery()" id="trigger-discovery-btn"
            class="px-3 py-1.5 bg-purple-600 text-white text-xs rounded-md hover:bg-purple-700">
      手動実行
    </button>
    {% endif %}
  </div>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
    <div>
      <div class="text-lg font-bold text-purple-700">{{ ai_keywords_active }}</div>
      <div class="text-[10px] text-gray-500">AI キーワード</div>
    </div>
    <div>
      <div class="text-lg font-bold text-amber-600">{{ auto_added_count }}</div>
      <div class="text-[10px] text-gray-500">自動登録済み</div>
    </div>
    <div>
      <div class="text-lg font-bold text-green-600">{{ ai_deals }}</div>
      <div class="text-[10px] text-gray-500">AI発見 Deal</div>
    </div>
    <div>
      {% if last_discovery_log %}
      <div class="text-xs font-semibold text-gray-700">{{ last_discovery_log.started_at.strftime('%m/%d %H:%M') }}</div>
      <div class="text-[10px] text-gray-500">最終実行</div>
      {% else %}
      <div class="text-xs font-semibold text-gray-400">-</div>
      <div class="text-[10px] text-gray-500">最終実行</div>
      {% endif %}
    </div>
  </div>
  <div id="discovery-msg" class="text-xs mt-2"></div>
</div>
{% endif %}


<!-- AI Seed Keywords (cold start) -->
{% if keywords|length < 5 and anthropic_configured %}
<div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg shadow-sm border border-amber-200 p-4 mb-4">
  <div class="flex items-center justify-between mb-2">
    <div>
      <span class="text-amber-700 font-bold text-sm">AIキーワード自動提案</span>
      <p class="text-xs text-gray-500 mt-0.5">Claude AIが転売で利益の出やすいキーワードを40件提案します。選んで一括登録できます。</p>
    </div>
    <button onclick="generateSeedKeywords()" id="seed-btn"
            class="px-3 py-1.5 bg-amber-600 text-white text-xs rounded-md hover:bg-amber-700 flex-shrink-0">
      AIに提案してもらう
    </button>
  </div>
  <div id="seed-msg" class="text-xs mt-1"></div>
  <div id="seed-results" class="hidden mt-3">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs text-gray-600"><span id="seed-count">0</span>件の候補</span>
      <div class="flex gap-2">
        <button onclick="toggleAllSeeds(true)" class="text-xs text-blue-600 hover:underline">全選択</button>
        <button onclick="toggleAllSeeds(false)" class="text-xs text-gray-500 hover:underline">全解除</button>
      </div>
    </div>
    <div id="seed-list" class="max-h-64 overflow-y-auto divide-y border rounded-md bg-white"></div>
    <div class="mt-3 flex items-center justify-between">
      <span class="text-xs text-gray-500" id="seed-selected-count">0件選択中</span>
      <button onclick="applySeedKeywords()" id="seed-apply-btn"
              class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
        選択したキーワードを登録
      </button>
    </div>
  </div>
</div>
{% endif %}

<!-- Add keyword form -->
<div class="bg-white rounded-lg shadow-sm border p-4 mb-4">
  <form onsubmit="addKeyword(event)" class="flex gap-3 items-end">
    <div class="flex-1">
      <label class="block text-xs font-medium text-gray-600 mb-1">キーワード追加</label>
      <input type="text" id="new-keyword" placeholder="例: Nintendo Switch, Pokemon Card BOX" required
             class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <button type="submit" class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
      追加
    </button>
  </form>
  <div id="add-msg" class="text-xs mt-1"></div>
</div>

<!-- Keywords list -->
<div class="bg-white rounded-lg shadow-sm border mb-4">
  <div class="px-4 py-3 border-b">
    <h2 class="text-sm font-semibold text-gray-900">登録キーワード ({{ keywords|length }}件)</h2>
  </div>
  {% if not keywords %}
  <div class="p-8 text-center text-sm text-gray-500">
    キーワードが登録されていません。上のフォームから追加してください。
  </div>
  {% else %}
  <div class="divide-y">
    {% for kw in keywords %}
    <div class="px-4 py-3 flex items-center gap-4" id="kw-row-{{ kw.id }}">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-900">{{ kw.keyword }}</span>
          {% if kw.source == 'manual' %}
          <span class="px-1.5 py-0.5 text-[10px] bg-gray-100 text-gray-500 rounded-full">手動</span>
          {% else %}
          <span class="px-1.5 py-0.5 text-[10px] bg-purple-100 text-purple-700 rounded-full">AI</span>
          {% endif %}
          {% if kw.auto_deactivated_at %}
          <span class="px-1.5 py-0.5 text-[10px] bg-red-100 text-red-600 rounded-full">自動停止</span>
          {% endif %}
        </div>
        <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
          <span>{{ kw.alert_count }}件のDeal</span>
          {% if kw.last_scanned_at %}
          <span>最終スキャン: {{ kw.last_scanned_at.strftime('%m/%d %H:%M') }}</span>
          {% else %}
          <span>未スキャン</span>
          {% endif %}
          {% if kw.source != 'manual' %}
          <span class="text-purple-500">スコア: {{ "%.0f"|format(kw.performance_score * 100) }}%</span>
          <span class="text-gray-400">{{ kw.total_scans }}回スキャン / {{ kw.total_deals_found }}件発見</span>
          {% endif %}
          {% if kw.notes %}
          <span class="text-gray-400">{{ kw.notes }}</span>
          {% endif %}
        </div>
        {% if kw.source != 'manual' and kw.performance_score is not none %}
        <div class="mt-1 w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden">
          <div class="h-full rounded-full
            {% if kw.performance_score >= 0.5 %}bg-green-500
            {% elif kw.performance_score >= 0.2 %}bg-amber-500
            {% else %}bg-red-400{% endif %}"
            style="width: {{ (kw.performance_score * 100)|int }}%"></div>
        </div>
        {% endif %}
      </div>
      <div class="relative flex items-center gap-2 flex-shrink-0">
        {% if scanner_available %}
        <button onclick="scanKeyword({{ kw.id }})" class="px-2 py-1 text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 rounded">
          スキャン
        </button>
        {% endif %}
        <button onclick="toggleKeyword({{ kw.id }}, {{ 'false' if kw.is_active else 'true' }})"
                class="px-2 py-1 text-xs rounded
                  {% if kw.is_active %}bg-green-50 text-green-600 hover:bg-green-100{% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}">
          {{ "有効" if kw.is_active else "無効" }}
        </button>
        <button onclick="showDeleteConfirm(this, null, {{ kw.id }})"
                class="px-2 py-1 text-xs bg-red-50 text-red-600 hover:bg-red-100 rounded">
          削除
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Recent alerts -->
<div class="bg-white rounded-lg shadow-sm border">
  <div class="px-4 py-3 border-b">
    <h2 class="text-sm font-semibold text-gray-900">最近のDeal通知</h2>
  </div>
  {% if not recent_alerts %}
  <div class="p-8 text-center text-sm text-gray-500">
    まだDeal通知はありません。キーワードを追加してスキャンを実行してください。
  </div>
  {% else %}
  <div class="divide-y">
    {% for alert in recent_alerts %}
    <div class="px-4 py-3" id="alert-row-{{ alert.id }}">
      <div class="flex items-start gap-3">
        <!-- Product images side by side -->
        <div class="flex gap-1 flex-shrink-0">
          <a href="{{ alert.yahoo_url }}" target="_blank" title="Yahoo">
            <img src="{{ alert.yahoo_image_url or '' }}"
                 alt="Yahoo" class="w-14 h-14 object-cover rounded border border-red-200 bg-gray-100"
                 onerror="this.style.display='none'">
          </a>
          <a href="https://amazon.co.jp/dp/{{ alert.amazon_asin }}" target="_blank" title="Amazon">
            <img src="https://m.media-amazon.com/images/P/{{ alert.amazon_asin }}.01._SCMZZZZZZZ_SX80_.jpg"
                 alt="Amazon" class="w-14 h-14 object-cover rounded border border-orange-200 bg-gray-100"
                 onerror="this.style.display='none'">
          </a>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-medium text-gray-900 truncate" title="{{ alert.yahoo_title }}">
            <span class="text-red-600">Y:</span> {{ alert.yahoo_title }}
          </div>
          {% if alert.amazon_title %}
          <div class="text-xs text-gray-600 truncate" title="{{ alert.amazon_title }}">
            <span class="text-orange-600">A:</span> {{ alert.amazon_title }}
          </div>
          {% endif %}
          <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1 text-xs">
            <span class="text-gray-500">仕入: <span class="font-semibold">&yen;{{ "{:,}".format(alert.yahoo_price) }}</span>{% if alert.yahoo_shipping %}<span class="text-gray-400"> +送料¥{{ "{:,}".format(alert.yahoo_shipping) }}</span>{% endif %}</span>
            <span class="text-gray-400">&rarr;</span>
            <span class="text-gray-500">販売: <span class="font-semibold text-purple-700">&yen;{{ "{:,}".format(alert.sell_price) }}</span>
              <span class="text-[10px] text-gray-400">(手数料{{ alert.amazon_fee_pct }}% / 転送¥{{ "{:,}".format(alert.forwarding_cost) }} / 利用料¥100)</span>
            </span>
          </div>
          <div class="flex items-center gap-x-2 mt-0.5 text-xs">
            <span class="font-semibold text-green-700">粗利 &yen;{{ "{:,}".format(alert.gross_profit) }} ({{ alert.gross_margin_pct }}%)</span>
            <span class="text-[10px] text-gray-400">{{ alert.notified_at.strftime('%m/%d %H:%M') }}</span>
          </div>
        </div>
        <!-- Action buttons -->
        <div class="relative flex flex-col gap-1.5 flex-shrink-0 ml-2">
          <button onclick="openListingModal({{ alert.id }}, '{{ alert.yahoo_auction_id }}', '{{ alert.amazon_asin }}', '{{ alert.yahoo_title|e }}', {{ alert.yahoo_price }}, {{ alert.yahoo_shipping }}, {{ alert.sell_price }}, {{ alert.amazon_fee_pct }}, {{ alert.forwarding_cost }})"
                  class="px-2.5 py-1 text-xs bg-green-600 text-white hover:bg-green-700 rounded font-medium">
            出品
          </button>
          <button onclick="showDeleteConfirm(this, {{ alert.id }}, null)"
                  class="px-2.5 py-1 text-xs bg-red-50 text-red-600 hover:bg-red-100 rounded">
            削除
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Listing modal -->
<div id="listing-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" onclick="closeListingModal()"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg relative my-4" onclick="event.stopPropagation()">
      <div class="px-5 py-4 border-b">
        <h3 class="text-base font-bold text-gray-900">Amazon出品確認</h3>
      </div>
      <div class="px-5 py-4 space-y-4 max-h-[80vh] overflow-y-auto">
        <!-- Product info -->
        <div class="flex gap-3">
          <div class="flex gap-1.5">
            <img id="modal-yahoo-img" src="" class="w-20 h-20 object-cover rounded border-2 border-red-300 bg-gray-100"
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect fill=%22%23f3f4f6%22 width=%2280%22 height=%2280%22/><text x=%2240%22 y=%2245%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>Yahoo</text></svg>'">
            <img id="modal-amazon-img" src="" class="w-20 h-20 object-cover rounded border-2 border-orange-300 bg-gray-100"
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect fill=%22%23f3f4f6%22 width=%2280%22 height=%2280%22/><text x=%2240%22 y=%2245%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>Amazon</text></svg>'">
          </div>
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium text-gray-900 line-clamp-2" id="modal-title"></div>
            <div class="text-xs text-gray-500 mt-1">ASIN: <span id="modal-asin" class="font-mono"></span></div>
          </div>
        </div>

        <!-- Price breakdown: cost → expenses → sell → profit -->
        <div class="bg-gray-50 rounded-lg p-3 space-y-2">
          <!-- Row 1: 仕入れ -->
          <div>
            <div class="text-[10px] font-medium text-gray-500 mb-1">仕入れ</div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-gray-600">即決価格</span>
              <span class="font-bold text-red-600" id="modal-yahoo-price"></span>
              <span class="text-gray-400">+</span>
              <span class="text-gray-600">送料</span>
              <span class="font-bold text-orange-500" id="modal-shipping"></span>
            </div>
            <div class="text-[10px] text-gray-400 mt-0.5" id="modal-total-cost"></div>
          </div>
          <!-- Row 2: Amazon経費 -->
          <div>
            <div class="text-[10px] font-medium text-gray-500 mb-1">Amazon経費</div>
            <div class="flex items-center gap-3 text-xs text-gray-600" id="modal-cost-breakdown">
              <span>転送: <span class="font-semibold" id="modal-forwarding-cost">-</span></span>
              <span>利用料: <span class="font-semibold">¥100</span></span>
              <span>販売手数料: <span class="font-semibold" id="modal-fee-pct">-</span></span>
            </div>
          </div>
          <!-- Row 3: 販売 -->
          <div class="border-t pt-2">
            <div class="flex items-center gap-3">
              <div>
                <div class="text-[10px] text-gray-500">Amazon相場</div>
                <div class="text-sm font-bold text-purple-700" id="modal-sell-price"></div>
              </div>
              <span class="text-gray-400 text-lg">&rarr;</span>
              <div>
                <div class="text-[10px] text-gray-500">出品価格</div>
                <input type="number" id="modal-list-price" class="w-20 text-sm font-bold text-green-700 text-center border rounded px-1 py-0.5"
                       oninput="_calcAndShowProfit()">
              </div>
              <div class="flex-1 text-right" id="modal-profit-display"></div>
            </div>
          </div>
        </div>

        <!-- Listing presets (per ASIN) -->
        <div id="preset-section" class="hidden">
          <label class="block text-xs font-medium text-gray-700 mb-1.5">前回の出品設定</label>
          <div id="preset-list" class="flex flex-col gap-1 max-h-40 overflow-y-auto"></div>
        </div>

        <!-- Condition selector -->
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1.5">コンディション</label>
          <div class="grid grid-cols-2 gap-2" id="condition-grid">
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
              <input type="radio" name="condition" value="used_like_new" class="text-blue-600">
              <div><div class="text-sm font-medium">ほぼ新品</div><div class="text-[10px] text-gray-400">Like New</div></div>
            </label>
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors border-blue-500 bg-blue-50">
              <input type="radio" name="condition" value="used_very_good" checked class="text-blue-600">
              <div><div class="text-sm font-medium">非常に良い</div><div class="text-[10px] text-gray-400">Very Good</div></div>
            </label>
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
              <input type="radio" name="condition" value="used_good" class="text-blue-600">
              <div><div class="text-sm font-medium">良い</div><div class="text-[10px] text-gray-400">Good</div></div>
            </label>
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
              <input type="radio" name="condition" value="used_acceptable" class="text-blue-600">
              <div><div class="text-sm font-medium">可</div><div class="text-[10px] text-gray-400">Acceptable</div></div>
            </label>
          </div>
        </div>

        <!-- Shipping pattern selector -->
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1.5">発送までの日数</label>
          <div class="grid grid-cols-3 gap-2" id="shipping-grid">
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
              <input type="radio" name="shipping_pattern" value="1_2_days" class="text-blue-600">
              <div><div class="text-sm font-medium">1〜2日</div><div class="text-[10px] text-gray-400">リードタイム4日</div></div>
            </label>
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors border-blue-500 bg-blue-50">
              <input type="radio" name="shipping_pattern" value="2_3_days" checked class="text-blue-600">
              <div><div class="text-sm font-medium">2〜3日</div><div class="text-[10px] text-gray-400">リードタイム6日</div></div>
            </label>
            <label class="flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
              <input type="radio" name="shipping_pattern" value="3_7_days" class="text-blue-600">
              <div><div class="text-sm font-medium">3〜7日</div><div class="text-[10px] text-gray-400">リードタイム9日</div></div>
            </label>
          </div>
        </div>

        <!-- Image gallery -->
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1.5">商品画像（Yahoo画像から選択）</label>
          <div id="modal-images-container">
            <div id="modal-images-loading" class="text-xs text-gray-400 py-3 text-center">画像を読み込み中...</div>
            <div id="modal-images-grid" class="grid grid-cols-4 gap-2 hidden"></div>
            <div id="modal-images-empty" class="text-xs text-gray-400 py-2 text-center hidden">画像が見つかりません</div>
          </div>
          <div class="text-[10px] text-gray-400 mt-1">最大9枚まで選択可能（1枚目がメイン画像）</div>
        </div>

        <!-- Condition note / description template -->
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <label class="block text-xs font-medium text-gray-700">商品説明</label>
            <button onclick="saveCurrentTemplate()" class="text-[10px] text-blue-600 hover:underline">テンプレートとして保存</button>
          </div>
          <textarea id="modal-condition-note" rows="5"
                    class="w-full text-sm border rounded-lg px-3 py-2 text-gray-800 focus:ring-1 focus:ring-blue-400 focus:border-blue-400"
                    placeholder="コンディション説明文..."></textarea>
          <div id="modal-template-msg" class="text-[10px] mt-0.5 h-4"></div>
        </div>

        <!-- Links -->
        <div class="flex gap-3 text-xs">
          <a id="modal-yahoo-link" href="#" target="_blank" class="text-red-600 hover:underline">Yahoo出品を確認</a>
          <a id="modal-amazon-link" href="#" target="_blank" class="text-orange-600 hover:underline">Amazon商品ページ</a>
        </div>

        <div id="modal-msg" class="text-xs"></div>
      </div>
      <div class="px-5 py-3 border-t bg-gray-50 rounded-b-xl flex items-center justify-between">
        <button onclick="closeListingModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900">キャンセル</button>
        <button onclick="submitListing()" id="modal-submit-btn"
                class="px-6 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
          Amazonに出品する
        </button>
      </div>
    </div>
  </div>
</div>

<script>
async function addKeyword(e) {
  e.preventDefault();
  const input = document.getElementById('new-keyword');
  const msgEl = document.getElementById('add-msg');
  const keyword = input.value.trim();
  if (!keyword) return;

  try {
    const resp = await fetch('/api/keywords', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({keyword: keyword}),
    });
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    window.location.reload();
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-1 text-red-600';
  }
}

async function toggleKeyword(id, active) {
  await fetch('/api/keywords/' + id, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({is_active: active}),
  });
  window.location.reload();
}

async function deleteKeyword(id, triggerBtn) {
  if (triggerBtn) triggerBtn.textContent = '...';
  try {
    const resp = await fetch('/api/keywords/' + id, {method: 'DELETE'});
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    const row = document.getElementById('kw-row-' + id);
    if (row) { row.style.transition = 'opacity 0.3s'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }
  } catch (e) {
    alert('削除に失敗しました: ' + e.message);
  }
}

async function scanKeyword(id) {
  const btn = event.target;
  btn.disabled = true; btn.textContent = 'スキャン中...';
  try {
    const resp = await fetch('/api/keywords/' + id + '/scan', {method: 'POST'});
    const data = await resp.json();
    btn.textContent = data.new_deals + '件の新規Deal';
    setTimeout(() => window.location.reload(), 1500);
  } catch (e) {
    btn.textContent = 'エラー';
    btn.disabled = false;
  }
}

async function scanAll() {
  const btn = document.getElementById('scan-all-btn');
  btn.disabled = true; btn.textContent = 'スキャン中...';
  try {
    await fetch('/api/keywords/scan', {method: 'POST'});
    window.location.reload();
  } catch (e) {
    btn.textContent = 'エラー';
    btn.disabled = false;
  }
}

async function triggerDiscovery() {
  const btn = document.getElementById('trigger-discovery-btn');
  const msgEl = document.getElementById('discovery-msg');
  btn.disabled = true; btn.textContent = '実行中...';
  msgEl.textContent = '';
  try {
    const resp = await fetch('/api/discovery/trigger', {method: 'POST'});
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    const data = await resp.json();
    msgEl.textContent = `候補 ${data.candidates_generated}件生成、${data.keywords_added}件追加`;
    msgEl.className = 'text-xs mt-2 text-green-600';
    setTimeout(() => window.location.reload(), 2000);
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-2 text-red-600';
    btn.textContent = '手動実行';
    btn.disabled = false;
  }
}

// --- Seed Keywords ---
let seedData = [];

async function generateSeedKeywords() {
  const btn = document.getElementById('seed-btn');
  const msgEl = document.getElementById('seed-msg');
  btn.disabled = true; btn.textContent = 'AIが分析中...';
  msgEl.textContent = '';
  try {
    const resp = await fetch('/api/discovery/seed', {method: 'POST'});
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    const data = await resp.json();
    seedData = data.suggestions;
    renderSeedList(seedData);
    document.getElementById('seed-results').classList.remove('hidden');
    document.getElementById('seed-count').textContent = seedData.length;
    btn.textContent = '再生成';
    btn.disabled = false;
    if (data.filtered_out > 0) {
      msgEl.textContent = `${data.filtered_out}件は既存キーワードと重複のため除外`;
      msgEl.className = 'text-xs mt-1 text-gray-500';
    }
  } catch (e) {
    msgEl.textContent = e.message;
    msgEl.className = 'text-xs mt-1 text-red-600';
    btn.textContent = 'AIに提案してもらう';
    btn.disabled = false;
  }
}

function renderSeedList(items) {
  const list = document.getElementById('seed-list');
  list.innerHTML = items.map((item, i) => `
    <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-50 cursor-pointer">
      <input type="checkbox" checked class="seed-cb rounded" data-index="${i}">
      <div class="flex-1 min-w-0">
        <div class="text-sm font-medium text-gray-900">${item.keyword}</div>
        <div class="text-xs text-gray-500 truncate">${item.category ? '<span class="text-purple-600">[' + item.category + ']</span> ' : ''}${item.reasoning}</div>
      </div>
      <span class="text-[10px] text-gray-400 flex-shrink-0">${Math.round(item.confidence * 100)}%</span>
    </label>
  `).join('');
  list.addEventListener('change', updateSeedCount);
  updateSeedCount();
}

function updateSeedCount() {
  const checked = document.querySelectorAll('.seed-cb:checked').length;
  document.getElementById('seed-selected-count').textContent = checked + '件選択中';
}

function toggleAllSeeds(checked) {
  document.querySelectorAll('.seed-cb').forEach(cb => cb.checked = checked);
  updateSeedCount();
}

async function applySeedKeywords() {
  const btn = document.getElementById('seed-apply-btn');
  const checked = document.querySelectorAll('.seed-cb:checked');
  if (checked.length === 0) { alert('キーワードを選択してください'); return; }

  const keywords = [];
  checked.forEach(cb => {
    const item = seedData[parseInt(cb.dataset.index)];
    keywords.push(item);
  });

  btn.disabled = true; btn.textContent = '登録中...';
  try {
    const resp = await fetch('/api/discovery/seed/apply', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({keywords: keywords}),
    });
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    const data = await resp.json();
    btn.textContent = data.added + '件登録完了';
    setTimeout(() => window.location.reload(), 1500);
  } catch (e) {
    alert(e.message);
    btn.textContent = '選択したキーワードを登録';
    btn.disabled = false;
  }
}

// --- Deal Alert Actions ---
let currentAlertId = null;

function showDeleteConfirm(btn, alertId, keywordId) {
  // Close any existing popover
  document.querySelectorAll('.delete-confirm-pop').forEach(el => el.remove());

  const isAlert = alertId != null;
  const pop = document.createElement('div');

  if (isAlert) {
    // Deal alert: show loading then fetch AI suggestions
    pop.className = 'delete-confirm-pop absolute right-full mr-2 top-1/2 -translate-y-1/2 bg-white border border-red-200 rounded-xl shadow-lg p-2.5 z-30 w-48';
    pop.innerHTML = '<div class="text-xs text-gray-400 py-2 text-center">分析中...</div>';
    btn.closest('.relative').appendChild(pop);
    _loadRejectionSuggestions(pop, alertId);
  } else {
    // Keyword: simple yes/no
    pop.className = 'delete-confirm-pop absolute right-full mr-2 top-1/2 -translate-y-1/2 bg-white border border-red-200 rounded-lg shadow-lg px-3 py-2 flex items-center gap-2 whitespace-nowrap z-30';
    pop.innerHTML = `
      <span class="text-xs text-gray-700">削除する？</span>
      <button class="px-2 py-0.5 text-xs bg-red-600 text-white rounded hover:bg-red-700" onclick="deleteKeyword(${keywordId}, this)">はい</button>
      <button class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200" onclick="this.closest('.delete-confirm-pop').remove()">いいえ</button>
    `;
    btn.closest('.relative').appendChild(pop);
  }

  // Auto-close after timeout (cancellable via pop._autoCloseTimer)
  const timeout = isAlert ? 10000 : 5000;
  pop._autoCloseTimer = setTimeout(() => { if (pop.parentNode) pop.remove(); }, timeout);

  // Close on outside click
  const handler = (e) => {
    if (!pop.contains(e.target) && e.target !== btn) {
      pop.remove();
      document.removeEventListener('click', handler);
    }
  };
  setTimeout(() => document.addEventListener('click', handler), 0);
}

const _REASON_COLORS = {
  'wrong_product': 'bg-red-50 text-red-700 hover:bg-red-100',
  'accessory': 'bg-orange-50 text-orange-700 hover:bg-orange-100',
  'model_variant': 'bg-amber-50 text-amber-700 hover:bg-amber-100',
  'bad_price': 'bg-purple-50 text-purple-700 hover:bg-purple-100',
  'other': 'bg-gray-50 text-gray-600 hover:bg-gray-100',
};

async function _loadRejectionSuggestions(pop, alertId) {
  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 1500);
    const resp = await fetch('/api/keywords/alerts/' + alertId + '/suggest-rejection', {signal: ctrl.signal});
    clearTimeout(timer);
    if (!resp.ok) throw new Error('Failed');
    const data = await resp.json();
    _renderSuggestionPopover(pop, alertId, data);
  } catch (e) {
    // Fallback to static reasons
    _renderStaticPopover(pop, alertId);
  }
}

function _renderSuggestionPopover(pop, alertId, data) {
  let html = '';
  const suggestions = data.suggestions || [];
  if (suggestions.length > 0) {
    html += '<div class="text-[10px] text-blue-500 mb-1 font-medium">AI推測:</div>';
    html += '<div class="flex flex-col gap-1 mb-1.5">';
    suggestions.forEach(s => {
      const colors = _REASON_COLORS[s.reason] || _REASON_COLORS['other'];
      const conf = Math.round(s.confidence * 100);
      html += `<button class="px-2 py-1.5 text-xs ${colors} rounded text-left flex justify-between items-center gap-1" onclick="rejectAlert(${alertId}, '${s.reason}', this)">`;
      html += `<span class="flex-1">${_escHtml(s.label)}</span>`;
      html += `<span class="text-[9px] opacity-60">${conf}%</span></button>`;
    });
    html += '</div>';
    html += '<div class="border-t border-gray-100 my-1"></div>';
  }
  // Static fallbacks (compact)
  html += '<div class="text-[10px] text-gray-400 mb-1">その他の理由:</div>';
  html += '<div class="flex flex-wrap gap-1">';
  (data.static_reasons || []).forEach(s => {
    // Skip reasons already in suggestions
    if (suggestions.some(sg => sg.reason === s.reason)) return;
    html += `<button class="px-1.5 py-0.5 text-[10px] bg-gray-50 text-gray-500 rounded hover:bg-gray-100" onclick="rejectAlert(${alertId}, '${s.reason}', this)">${_escHtml(s.label)}</button>`;
  });
  html += '</div>';
  html += '<button class="mt-1.5 w-full px-2 py-0.5 text-[10px] text-gray-400 hover:text-gray-600" onclick="this.closest(\'.delete-confirm-pop\').remove()">キャンセル</button>';
  pop.innerHTML = html;
}

function _renderStaticPopover(pop, alertId) {
  pop.innerHTML = `
    <div class="text-[10px] text-gray-500 mb-1.5 font-medium">NG理由を選択</div>
    <div class="flex flex-col gap-1">
      <button class="px-2 py-1 text-xs bg-red-50 text-red-700 rounded hover:bg-red-100 text-left" onclick="rejectAlert(${alertId}, 'wrong_product', this)">商品違い</button>
      <button class="px-2 py-1 text-xs bg-orange-50 text-orange-700 rounded hover:bg-orange-100 text-left" onclick="rejectAlert(${alertId}, 'accessory', this)">部品/アクセサリー</button>
      <button class="px-2 py-1 text-xs bg-amber-50 text-amber-700 rounded hover:bg-amber-100 text-left" onclick="rejectAlert(${alertId}, 'model_variant', this)">モデル違い</button>
      <button class="px-2 py-1 text-xs bg-purple-50 text-purple-700 rounded hover:bg-purple-100 text-left" onclick="rejectAlert(${alertId}, 'bad_price', this)">価格おかしい</button>
      <button class="px-2 py-1 text-xs bg-gray-50 text-gray-600 rounded hover:bg-gray-100 text-left" onclick="rejectAlert(${alertId}, 'other', this)">その他</button>
    </div>
    <button class="mt-1.5 w-full px-2 py-0.5 text-[10px] text-gray-400 hover:text-gray-600" onclick="this.closest('.delete-confirm-pop').remove()">キャンセル</button>
  `;
}

function _escHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

async function rejectAlert(alertId, reason, triggerBtn, note) {
  if (triggerBtn) { triggerBtn.textContent = '...'; triggerBtn.disabled = true; }
  try {
    const payload = {reason: reason};
    if (note) payload.note = note;
    const resp = await fetch('/api/keywords/alerts/' + alertId + '/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
    });
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    // Remove popover and fade out row
    document.querySelectorAll('.delete-confirm-pop').forEach(el => el.remove());
    const row = document.getElementById('alert-row-' + alertId);
    if (row) { row.style.transition = 'opacity 0.3s'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }
  } catch (e) {
    alert('エラー: ' + e.message);
    if (triggerBtn) { triggerBtn.textContent = 'リトライ'; triggerBtn.disabled = false; }
  }
}

function _showOtherNoteInput(alertId, triggerBtn) {
  // Replace popover content with note input form
  const pop = triggerBtn.closest('.delete-confirm-pop');
  if (!pop) return;
  // Cancel auto-close timer — user is typing
  if (pop._autoCloseTimer) { clearTimeout(pop._autoCloseTimer); pop._autoCloseTimer = null; }
  pop.style.width = '260px';
  pop.innerHTML = `
    <div class="text-[10px] text-gray-500 mb-1.5 font-medium">削除理由を入力（任意）</div>
    <textarea id="reject-note-${alertId}" rows="3" placeholder="例: ヤフオクはボディのみ、Amazonはレンズキット"
              class="w-full text-xs border rounded px-2 py-1.5 focus:ring-1 focus:ring-red-300 focus:border-red-300 resize-none"></textarea>
    <div class="flex gap-1.5 mt-1.5">
      <button class="flex-1 px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
              onclick="_submitOtherReject(${alertId}, this)">削除する</button>
      <button class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200"
              onclick="this.closest('.delete-confirm-pop').remove()">戻る</button>
    </div>
  `;
  // Auto-focus textarea
  setTimeout(() => {
    const ta = document.getElementById('reject-note-' + alertId);
    if (ta) ta.focus();
  }, 50);
}

function _submitOtherReject(alertId, btn) {
  const note = (document.getElementById('reject-note-' + alertId)?.value || '').trim();
  rejectAlert(alertId, 'other', btn, note || '');
}

// Profit calculation state
let _profitParams = {};

function _calcAndShowProfit() {
  const p = _profitParams;
  const listPrice = parseInt(document.getElementById('modal-list-price').value) || 0;
  const el = document.getElementById('modal-profit-display');
  if (!listPrice || !p.yahooPrice) { el.textContent = ''; return; }

  const amazonFee = Math.round(listPrice * p.feePct / 100);
  const totalCost = p.yahooPrice + p.yahooShipping + p.forwardingCost + 100;  // 100 = system fee
  const profit = listPrice - totalCost - amazonFee;
  const marginPct = listPrice > 0 ? (profit / listPrice * 100).toFixed(1) : 0;

  const color = profit > 0 ? 'text-green-700' : 'text-red-600';
  el.className = 'text-sm font-bold text-right ' + color;
  el.innerHTML = '粗利 ¥' + profit.toLocaleString() + '<div class="text-[10px] font-normal text-gray-400">' + marginPct + '%</div>';
}

async function openListingModal(alertId, auctionId, asin, title, yahooPrice, yahooShipping, sellPrice, feePct, forwardingCost) {
  // 事前チェック: 既にAmazon出品済みか確認
  try {
    const resp = await fetch('/api/items/' + auctionId);
    if (resp.ok) {
      const item = await resp.json();
      if (item.amazon_sku) {
        alert('この商品は既にAmazonに出品済みです（SKU: ' + item.amazon_sku + '）');
        return;
      }
    }
  } catch (_) { /* MonitoredItem未登録 = 初回出品 → OK */ }

  currentAlertId = alertId;

  // Store params for profit calculation
  _profitParams = {
    yahooPrice: yahooPrice,
    yahooShipping: yahooShipping || 0,
    feePct: feePct || 10.0,
    forwardingCost: forwardingCost || 0,
  };

  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-asin').textContent = asin;
  document.getElementById('modal-yahoo-price').textContent = '¥' + yahooPrice.toLocaleString();
  document.getElementById('modal-shipping').textContent = yahooShipping > 0 ? '¥' + yahooShipping.toLocaleString() : '不明';
  document.getElementById('modal-sell-price').textContent = '¥' + sellPrice.toLocaleString();
  document.getElementById('modal-list-price').value = sellPrice;
  const totalCost = yahooPrice + (yahooShipping || 0);
  document.getElementById('modal-total-cost').textContent = yahooShipping > 0
    ? '小計 ¥' + totalCost.toLocaleString()
    : '※送料は地域によって異なります';

  // Display Amazon cost breakdown
  document.getElementById('modal-forwarding-cost').textContent = '¥' + (forwardingCost || 0).toLocaleString();
  document.getElementById('modal-fee-pct').textContent = (feePct || 10) + '%';

  // Set images
  const alertRow = document.getElementById('alert-row-' + alertId);
  const imgs = alertRow ? alertRow.querySelectorAll('img') : [];
  document.getElementById('modal-yahoo-img').src = imgs[0] ? imgs[0].src : '';
  document.getElementById('modal-amazon-img').src = imgs[1] ? imgs[1].src : '';

  // Set links
  document.getElementById('modal-yahoo-link').href = 'https://auctions.yahoo.co.jp/jp/auction/' + auctionId;
  document.getElementById('modal-amazon-link').href = 'https://amazon.co.jp/dp/' + asin;

  // Reset condition to default
  const radios = document.querySelectorAll('input[name="condition"]');
  radios.forEach(r => { r.checked = r.value === 'used_very_good'; });
  updateConditionHighlight();

  // Reset shipping pattern to default
  document.querySelectorAll('input[name="shipping_pattern"]').forEach(r => {
    r.checked = r.value === '2_3_days';
    const label = r.closest('label');
    if (r.checked) { label.classList.add('border-blue-500', 'bg-blue-50'); }
    else { label.classList.remove('border-blue-500', 'bg-blue-50'); }
  });

  // Reset messages
  document.getElementById('modal-msg').textContent = '';
  document.getElementById('modal-template-msg').textContent = '';
  document.getElementById('modal-submit-btn').disabled = false;
  document.getElementById('modal-submit-btn').textContent = 'Amazonに出品する';

  // Load Yahoo images for this alert
  _loadModalImages(alertId);

  // Load ASIN presets first, then condition templates as fallback
  await _loadPresets(asin);

  // Load condition templates and apply current condition,
  // but only if no preset was auto-applied
  if (!document.getElementById('preset-section').dataset.applied) {
    await _loadTemplates();
    _applyTemplate(document.querySelector('input[name="condition"]:checked').value);
    // Check if MonitoredItem has a saved condition_note
    try {
      const resp = await fetch('/api/items/' + auctionId);
      if (resp.ok) {
        const item = await resp.json();
        if (item.amazon_condition_note) {
          document.getElementById('modal-condition-note').value = item.amazon_condition_note;
        }
      }
    } catch (_) { /* ignore — first-time listing */ }
  }

  // Calculate initial profit
  _calcAndShowProfit();

  document.getElementById('listing-modal').classList.remove('hidden');
}

function closeListingModal() {
  document.getElementById('listing-modal').classList.add('hidden');
  currentAlertId = null;
}

async function submitListing() {
  if (!currentAlertId) return;
  const btn = document.getElementById('modal-submit-btn');
  const msgEl = document.getElementById('modal-msg');
  const condition = document.querySelector('input[name="condition"]:checked').value;
  const price = parseInt(document.getElementById('modal-list-price').value);

  if (!price || price <= 0) {
    msgEl.textContent = '出品価格を入力してください';
    msgEl.className = 'text-xs text-red-600';
    return;
  }

  // Collect selected image URLs
  const imageUrls = [];
  document.querySelectorAll('#modal-images-grid input[type="checkbox"]:checked').forEach(cb => {
    imageUrls.push(cb.dataset.url);
  });

  // Collect condition note
  const conditionNote = document.getElementById('modal-condition-note').value.trim();

  btn.disabled = true; btn.textContent = '出品処理中...';
  msgEl.textContent = '';

  try {
    const shippingPattern = document.querySelector('input[name="shipping_pattern"]:checked').value;
    const body = {condition, price, shipping_pattern: shippingPattern};
    if (conditionNote) body.condition_note = conditionNote;
    if (imageUrls.length > 0) body.image_urls = imageUrls;

    const resp = await fetch('/api/keywords/alerts/' + currentAlertId + '/list', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    const data = await resp.json();
    if (!resp.ok) { throw new Error(data.detail || 'Failed'); }

    // Auto-save listing preset (fire-and-forget)
    const presetAsin = document.getElementById('modal-asin').textContent.trim();
    if (presetAsin) {
      fetch('/api/presets', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          asin: presetAsin,
          condition: condition,
          condition_note: conditionNote || '',
          shipping_pattern: shippingPattern,
        }),
      }).catch(() => {});
    }

    msgEl.textContent = 'Amazon出品完了！ SKU: ' + data.amazon_sku;
    msgEl.className = 'text-xs text-green-600 font-medium';
    btn.textContent = '出品完了';
    setTimeout(() => {
      closeListingModal();
      window.location.reload();
    }, 2000);
  } catch (e) {
    msgEl.textContent = '出品失敗: ' + e.message;
    msgEl.className = 'text-xs text-red-600';
    btn.textContent = 'Amazonに出品する';
    btn.disabled = false;
  }
}

// --- Modal Image Gallery ---
async function _loadModalImages(alertId) {
  const loading = document.getElementById('modal-images-loading');
  const grid = document.getElementById('modal-images-grid');
  const empty = document.getElementById('modal-images-empty');

  // Reset state
  loading.classList.remove('hidden');
  grid.classList.add('hidden');
  grid.innerHTML = '';
  empty.classList.add('hidden');

  try {
    const resp = await fetch('/api/keywords/alerts/' + alertId + '/images');
    if (!resp.ok) throw new Error('Failed');
    const data = await resp.json();
    const images = data.images || [];

    loading.classList.add('hidden');

    if (images.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    images.forEach((url, i) => {
      const label = document.createElement('label');
      label.className = 'relative cursor-pointer group';
      label.innerHTML = `
        <input type="checkbox" ${i === 0 ? 'checked' : ''} data-url="${_escHtml(url)}"
               class="absolute top-1 left-1 z-10 rounded text-blue-600"
               onchange="_enforceMaxImages()">
        <img src="${_escHtml(url)}" alt="Image ${i + 1}"
             class="w-full aspect-square object-cover rounded border-2 ${i === 0 ? 'border-blue-500' : 'border-gray-200'} group-hover:border-blue-400 bg-gray-100"
             onerror="this.parentElement.style.display='none'">
        ${i === 0 ? '<span class="absolute bottom-0 left-0 right-0 text-center text-[9px] bg-blue-600 text-white rounded-b">メイン</span>' : ''}
      `;
      grid.appendChild(label);
    });

    grid.classList.remove('hidden');
  } catch (e) {
    loading.classList.add('hidden');
    empty.textContent = '画像の読み込みに失敗しました';
    empty.classList.remove('hidden');
  }
}

function _enforceMaxImages() {
  const checkboxes = document.querySelectorAll('#modal-images-grid input[type="checkbox"]');
  const checked = document.querySelectorAll('#modal-images-grid input[type="checkbox"]:checked');
  if (checked.length >= 9) {
    checkboxes.forEach(cb => { if (!cb.checked) cb.disabled = true; });
  } else {
    checkboxes.forEach(cb => { cb.disabled = false; });
  }
  // Update first image border highlight
  checkboxes.forEach((cb, i) => {
    const img = cb.parentElement.querySelector('img');
    if (img) {
      if (cb.checked) {
        img.classList.remove('border-gray-200');
        img.classList.add('border-blue-500');
      } else {
        img.classList.remove('border-blue-500');
        img.classList.add('border-gray-200');
      }
    }
  });
}

// --- Condition Templates ---
let _templateCache = null;

async function _loadTemplates() {
  if (_templateCache) return;
  try {
    const resp = await fetch('/api/templates');
    if (!resp.ok) throw new Error('Failed');
    _templateCache = await resp.json();
  } catch (e) {
    _templateCache = {};
  }
}

function _applyTemplate(condition) {
  const textarea = document.getElementById('modal-condition-note');
  if (!_templateCache) return;
  const tpl = _templateCache[condition];
  if (tpl && tpl.body) {
    textarea.value = tpl.body;
  } else {
    textarea.value = '';
  }
}

async function saveCurrentTemplate() {
  const condition = document.querySelector('input[name="condition"]:checked').value;
  const body = document.getElementById('modal-condition-note').value.trim();
  const msgEl = document.getElementById('modal-template-msg');

  if (!body) {
    msgEl.textContent = '説明文が空です';
    msgEl.className = 'text-[10px] mt-0.5 h-4 text-red-500';
    return;
  }

  try {
    const resp = await fetch('/api/templates/' + condition, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({body: body}),
    });
    if (!resp.ok) throw new Error('Failed');
    // Update cache
    if (_templateCache) {
      if (!_templateCache[condition]) _templateCache[condition] = {};
      _templateCache[condition].body = body;
    }
    msgEl.textContent = 'テンプレートを保存しました';
    msgEl.className = 'text-[10px] mt-0.5 h-4 text-green-600';
    setTimeout(() => { msgEl.textContent = ''; }, 3000);
  } catch (e) {
    msgEl.textContent = '保存に失敗しました';
    msgEl.className = 'text-[10px] mt-0.5 h-4 text-red-500';
  }
}

// --- ASIN Listing Presets ---
const _conditionLabels = {
  'used_like_new': 'ほぼ新品',
  'used_very_good': '非常に良い',
  'used_good': '良い',
  'used_acceptable': '可',
};
const _shippingLabels = {
  '1_2_days': '1〜2日',
  '2_3_days': '2〜3日',
  '3_7_days': '3〜7日',
};

async function _loadPresets(asin) {
  const section = document.getElementById('preset-section');
  const list = document.getElementById('preset-list');
  section.classList.add('hidden');
  section.dataset.applied = '';
  list.innerHTML = '';

  if (!asin) return;

  try {
    const resp = await fetch('/api/presets/' + encodeURIComponent(asin));
    if (!resp.ok) return;
    const presets = await resp.json();
    if (!presets || presets.length === 0) return;

    presets.forEach((p, idx) => {
      const notePreview = p.condition_note
        ? (p.condition_note.length > 35 ? p.condition_note.substring(0, 35) + '…' : p.condition_note)
        : '（説明文なし）';
      const card = document.createElement('button');
      card.type = 'button';
      card.className = 'w-full text-left px-3 py-2 border rounded-lg text-xs hover:bg-indigo-50 hover:border-indigo-400 transition-colors ' +
        (idx === 0 ? 'border-indigo-400 bg-indigo-50' : 'border-gray-200');
      card.innerHTML =
        '<span class="font-medium text-indigo-700">' + (_conditionLabels[p.condition] || p.condition) + '</span>' +
        '<span class="text-gray-400 mx-1">|</span>' +
        '<span class="text-gray-600">' + notePreview + '</span>' +
        '<span class="text-gray-400 mx-1">|</span>' +
        '<span class="text-gray-500">' + (_shippingLabels[p.shipping_pattern] || p.shipping_pattern) + '</span>';
      card.onclick = () => { _applyPreset(p); _highlightPresetCard(card); };
      list.appendChild(card);
    });

    section.classList.remove('hidden');

    // Auto-apply first (newest) preset
    _applyPreset(presets[0]);
    _highlightPresetCard(list.firstChild);
    section.dataset.applied = '1';
  } catch (_) { /* ignore preset load errors */ }
}

function _applyPreset(preset) {
  // Set condition radio
  const condRadio = document.querySelector('input[name="condition"][value="' + preset.condition + '"]');
  if (condRadio) {
    condRadio.checked = true;
    updateConditionHighlight();
  }

  // Set condition note
  document.getElementById('modal-condition-note').value = preset.condition_note || '';

  // Set shipping pattern radio
  const shipRadio = document.querySelector('input[name="shipping_pattern"][value="' + preset.shipping_pattern + '"]');
  if (shipRadio) {
    shipRadio.checked = true;
    document.querySelectorAll('#shipping-grid label').forEach(label => {
      const r = label.querySelector('input[type="radio"]');
      if (r.checked) { label.classList.add('border-blue-500', 'bg-blue-50'); }
      else { label.classList.remove('border-blue-500', 'bg-blue-50'); }
    });
  }

}

function _highlightPresetCard(activeCard) {
  document.querySelectorAll('#preset-list button').forEach(btn => {
    btn.classList.remove('border-indigo-400', 'bg-indigo-50');
    btn.classList.add('border-gray-200');
  });
  activeCard.classList.add('border-indigo-400', 'bg-indigo-50');
  activeCard.classList.remove('border-gray-200');
}

// Condition radio highlight
function updateConditionHighlight() {
  document.querySelectorAll('#condition-grid label').forEach(label => {
    const radio = label.querySelector('input[type="radio"]');
    if (radio.checked) {
      label.classList.add('border-blue-500', 'bg-blue-50');
    } else {
      label.classList.remove('border-blue-500', 'bg-blue-50');
    }
  });
}
document.querySelectorAll('input[name="condition"]').forEach(r => {
  r.addEventListener('change', async () => {
    updateConditionHighlight();
    await _loadTemplates();
    _applyTemplate(r.value);
  });
});

// Shipping pattern highlight
function updateShippingHighlight() {
  document.querySelectorAll('#shipping-grid label').forEach(label => {
    const radio = label.querySelector('input[type="radio"]');
    if (radio.checked) {
      label.classList.add('border-blue-500', 'bg-blue-50');
    } else {
      label.classList.remove('border-blue-500', 'bg-blue-50');
    }
  });
}
document.querySelectorAll('input[name="shipping_pattern"]').forEach(r => {
  r.addEventListener('change', updateShippingHighlight);
});

// Close modal on Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeListingModal();
});
</script>
{% endblock %}
