{% extends "base.html" %}
{% block title %}出品モニタリング - ヤフアマ{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-xl font-bold text-gray-900">出品モニタリング</h1>
    <p class="text-sm text-gray-500 mt-1">Amazonに出品した商品の状況を管理します。</p>
  </div>
</div>

<!-- Filter tabs -->
<div class="flex space-x-1 mb-4 bg-gray-100 rounded-lg p-1 w-fit">
  {% for val, label in [("", "すべて"), ("active", "ヤフオク出品中"), ("ended_sold", "落札済"), ("ended_no_winner", "終了")] %}
  <a href="/items{% if val %}?status={{ val }}{% endif %}"
     class="px-3 py-1 text-xs rounded-md {% if status_filter == val %}bg-white shadow text-gray-900{% else %}text-gray-600 hover:text-gray-900{% endif %}">
    {{ label }}
  </a>
  {% endfor %}
</div>

<!-- Item list -->
{% set yahoo_labels = {"active": "出品中", "ended_sold": "落札済", "ended_no_winner": "終了"} %}
<div class="bg-white rounded-lg shadow-sm border divide-y">
  {% for item in items %}
  {# --- 利益計算 --- #}
  {% set yahoo_cost = item.estimated_win_price or item.current_price %}
  {% set sell_price = item.amazon_price or 0 %}
  {% set amazon_fee = (sell_price * item.amazon_fee_pct / 100)|round|int if sell_price else 0 %}
  {% set total_cost = yahoo_cost + item.shipping_cost + item.forwarding_cost + 100 + amazon_fee %}
  {% set gross_profit = sell_price - total_cost if sell_price else 0 %}
  {% set margin_pct = ((gross_profit / sell_price * 100)|round(1)) if sell_price > 0 else 0 %}

  <a href="/items/{{ item.auction_id }}" class="block px-4 py-3 hover:bg-gray-50">
    <div class="flex items-start gap-3">
      {# 画像 #}
      {% if item.image_url %}
      <img src="{{ item.image_url }}" alt="" class="w-16 h-16 object-cover rounded flex-shrink-0">
      {% else %}
      <div class="w-16 h-16 bg-gray-200 rounded flex-shrink-0"></div>
      {% endif %}

      {# メイン情報 #}
      <div class="min-w-0 flex-1">
        {# タイトル + ステータスバッジ #}
        <div class="text-sm font-medium text-gray-900 truncate">{{ item.title or item.auction_id }}</div>
        <div class="flex flex-wrap items-center gap-1.5 mt-1">
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium
            {% if item.status == 'active' %}bg-green-100 text-green-700
            {% elif item.status == 'ended_sold' %}bg-blue-100 text-blue-700
            {% else %}bg-gray-100 text-gray-600{% endif %}">{{ yahoo_labels.get(item.status, item.status) }}</span>
          {% if item.amazon_listing_status == 'active' %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-100 text-purple-700">Amazon出品中</span>
          {% elif item.amazon_listing_status == 'delisted' %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-orange-100 text-orange-700">Amazon取下げ</span>
          {% elif item.amazon_listing_status == 'error' %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-red-100 text-red-700">Amazonエラー</span>
          {% elif item.amazon_listing_status == 'inactive' %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-600">Amazon停止</span>
          {% endif %}
          {% set cl_status = checklist_complete(item) %}
          {% if cl_status == false %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-100 text-yellow-700">&#9888; 未確認</span>
          {% elif cl_status == true %}
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-green-100 text-green-700">&#10003; 確認済</span>
          {% endif %}
          {% if item.bid_count > 0 %}
          <span class="text-[10px] text-orange-600 font-medium">{{ item.bid_count }}件入札</span>
          {% endif %}
        </div>

        {# 価格・利益情報 #}
        <div class="flex flex-wrap items-center gap-x-3 gap-y-0.5 mt-1.5 text-xs">
          {# 仕入れ（即決価格） #}
          <span class="text-gray-500">仕入
            <span class="font-semibold text-gray-800">&yen;{{ "{:,}".format(yahoo_cost) }}</span>
          </span>
          {% if sell_price > 0 %}
          <span class="text-gray-400">&rarr;</span>
          {# Amazon売価 #}
          <span class="text-gray-500">売価
            <span class="font-semibold text-purple-700">&yen;{{ "{:,}".format(sell_price) }}</span>
          </span>
          <span class="text-gray-400">&rarr;</span>
          {# 粗利 #}
          <span class="font-bold {% if gross_profit > 0 %}text-green-700{% else %}text-red-600{% endif %}">
            &yen;{{ "{:,}".format(gross_profit) }}
            <span class="font-normal text-[10px]">({{ margin_pct }}%)</span>
          </span>
          {% endif %}
        </div>
      </div>

      {# 右側: 削除ボタン #}
      <div class="flex-shrink-0">
        {% if item.status.startswith('ended_') %}
        <button onclick="event.preventDefault(); event.stopPropagation(); deleteItem('{{ item.auction_id }}')"
                class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-red-100 hover:text-red-700 transition-colors">
          削除
        </button>
        {% endif %}
      </div>
    </div>
  </a>
  {% else %}
  <div class="px-4 py-8 text-center text-sm text-gray-500">出品中の商品はありません。</div>
  {% endfor %}
</div>

<script>
async function deleteItem(auctionId) {
  if (!confirm('この商品をモニタリングから削除しますか？')) return;
  try {
    const resp = await fetch(`/api/items/${auctionId}`, {method: 'DELETE'});
    if (resp.ok) {
      location.reload();
    } else {
      const data = await resp.json().catch(() => ({}));
      alert(data.detail || '削除に失敗しました');
    }
  } catch (e) {
    alert('通信エラー: ' + e.message);
  }
}
</script>
{% endblock %}
