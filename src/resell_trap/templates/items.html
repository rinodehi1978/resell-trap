{% extends "base.html" %}
{% block title %}Items - Resell Trap{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-xl font-bold text-gray-900">Monitored Items</h1>
  <button @click="$refs.addDialog.showModal()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
    + Add Item
  </button>
</div>

<!-- Filter tabs -->
<div class="flex space-x-1 mb-4 bg-gray-100 rounded-lg p-1 w-fit">
  {% for val, label in [("", "All"), ("active", "Active"), ("ended_sold", "Sold"), ("ended_no_winner", "Ended")] %}
  <a href="/items{% if val %}?status={{ val }}{% endif %}"
     class="px-3 py-1 text-xs rounded-md {% if status_filter == val %}bg-white shadow text-gray-900{% else %}text-gray-600 hover:text-gray-900{% endif %}">
    {{ label }}
  </a>
  {% endfor %}
</div>

<!-- Item list -->
<div class="bg-white rounded-lg shadow-sm border divide-y">
  {% for item in items %}
  <a href="/items/{{ item.auction_id }}" class="flex items-center px-4 py-3 hover:bg-gray-50 gap-3">
    {% if item.image_url %}
    <img src="{{ item.image_url }}" alt="" class="w-14 h-14 object-cover rounded flex-shrink-0">
    {% else %}
    <div class="w-14 h-14 bg-gray-200 rounded flex-shrink-0"></div>
    {% endif %}
    <div class="min-w-0 flex-1">
      <div class="text-sm font-medium text-gray-900 truncate">{{ item.title or item.auction_id }}</div>
      <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
        <span class="inline-block px-1.5 py-0.5 rounded font-medium
          {% if item.status == 'active' %}bg-green-100 text-green-700
          {% elif item.status == 'ended_sold' %}bg-blue-100 text-blue-700
          {% else %}bg-gray-100 text-gray-600{% endif %}">{{ item.status }}</span>
        <span>&yen;{{ "{:,}".format(item.current_price) }}</span>
        {% if item.bid_count > 0 %}<span>{{ item.bid_count }} bids</span>{% endif %}
        {% if item.amazon_sku %}<span class="text-purple-600">Amazon: {{ item.amazon_sku }}</span>{% endif %}
      </div>
    </div>
    <div class="text-right flex-shrink-0">
      {% if item.amazon_price %}
      <div class="text-sm font-medium text-purple-700">&yen;{{ "{:,}".format(item.amazon_price) }}</div>
      <div class="text-xs text-gray-400">Amazon</div>
      {% endif %}
    </div>
  </a>
  {% else %}
  <div class="px-4 py-8 text-center text-sm text-gray-500">No items found.</div>
  {% endfor %}
</div>

<!-- Add item dialog -->
<dialog x-ref="addDialog" class="rounded-lg shadow-xl p-0 w-full max-w-md backdrop:bg-gray-900/50">
  <form method="dialog" class="p-6">
    <h2 class="text-lg font-semibold mb-4">Add Monitored Item</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Auction ID or URL</label>
        <input type="text" id="add-auction-id" placeholder="e.g. x1234567890 or Yahoo Auction URL"
               class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
        <input type="text" id="add-notes" placeholder=""
               class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-6">
      <button type="submit" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md">Cancel</button>
      <button type="button" id="add-submit-btn" onclick="addItem()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
        Add
      </button>
    </div>
    <div id="add-error" class="mt-3 text-sm text-red-600 hidden"></div>
  </form>
</dialog>

<script>
async function addItem() {
  const auctionId = document.getElementById('add-auction-id').value.trim();
  const notes = document.getElementById('add-notes').value.trim();
  const errEl = document.getElementById('add-error');
  const btn = document.getElementById('add-submit-btn');
  if (!auctionId) { errEl.textContent = 'Auction ID is required'; errEl.classList.remove('hidden'); return; }
  btn.disabled = true; btn.textContent = 'Adding...';
  errEl.classList.add('hidden');
  try {
    const resp = await fetch('/api/items', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({auction_id: auctionId, notes: notes}),
    });
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    window.location.reload();
  } catch (e) {
    errEl.textContent = e.message; errEl.classList.remove('hidden');
    btn.disabled = false; btn.textContent = 'Add';
  }
}
</script>
{% endblock %}
