{% extends "base.html" %}
{% block title %}{{ item.title or item.auction_id }} - Resell Trap{% endblock %}

{% block content %}
<div class="mb-4">
  <a href="/items" class="text-sm text-blue-600 hover:underline">&larr; Back to Items</a>
</div>

<div class="grid lg:grid-cols-3 gap-4">
  <!-- Main info -->
  <div class="lg:col-span-2 space-y-4">
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <div class="flex gap-4">
        {% if item.image_url %}
        <img src="{{ item.image_url }}" alt="" class="w-24 h-24 object-cover rounded flex-shrink-0">
        {% endif %}
        <div class="min-w-0">
          <h1 class="text-lg font-bold text-gray-900">{{ item.title or item.auction_id }}</h1>
          <div class="mt-1 flex items-center gap-2 text-sm">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium
              {% if item.status == 'active' %}bg-green-100 text-green-700
              {% elif item.status == 'ended_sold' %}bg-blue-100 text-blue-700
              {% else %}bg-gray-100 text-gray-600{% endif %}">{{ item.status }}</span>
            <a href="{{ item.url }}" target="_blank" class="text-blue-600 hover:underline text-xs">Yahoo Auctions &rarr;</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Price info -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-3">Price Information</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
        <div>
          <div class="text-gray-500 text-xs">Current</div>
          <div class="font-semibold">&yen;{{ "{:,}".format(item.current_price) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Start</div>
          <div>&yen;{{ "{:,}".format(item.start_price) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Buy Now</div>
          <div>{% if item.buy_now_price %}&yen;{{ "{:,}".format(item.buy_now_price) }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Bids</div>
          <div>{{ item.bid_count }}</div>
        </div>
      </div>
    </div>

    <!-- Amazon info -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-900">Amazon</h2>
        {% if not item.amazon_asin %}
        <button onclick="document.getElementById('asin-dialog').showModal()"
                class="px-2 py-1 text-xs bg-purple-100 text-purple-700 hover:bg-purple-200 rounded">
          + Set ASIN
        </button>
        {% endif %}
      </div>

      {% if item.amazon_asin %}
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm mb-3">
        <div>
          <div class="text-gray-500 text-xs">ASIN</div>
          <div class="font-mono text-xs">{{ item.amazon_asin }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">SKU</div>
          <div class="font-mono text-xs">{{ item.amazon_sku or "-" }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Amazon Price</div>
          <div class="font-semibold text-purple-700">
            {% if item.amazon_price %}&yen;{{ "{:,}".format(item.amazon_price) }}{% else %}-{% endif %}
          </div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Listing Status</div>
          <div>
            {% if item.amazon_listing_status == 'active' %}
            <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs">active</span>
            {% elif item.amazon_listing_status %}
            <span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">{{ item.amazon_listing_status }}</span>
            {% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-3 text-sm">
        <div>
          <div class="text-gray-500 text-xs">Estimated Win</div>
          <div>&yen;{{ "{:,}".format(item.estimated_win_price) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Shipping</div>
          <div>&yen;{{ "{:,}".format(item.shipping_cost) }}</div>
        </div>
        <div>
          <div class="text-gray-500 text-xs">Margin</div>
          <div>{{ item.amazon_margin_pct }}%</div>
        </div>
      </div>

      {% if not item.amazon_sku %}
      <div class="mt-3 pt-3 border-t">
        <button onclick="createAmazonListing()" id="create-listing-btn"
                class="px-3 py-1.5 text-xs bg-purple-600 text-white hover:bg-purple-700 rounded">
          Create Amazon Listing
        </button>
        <span id="create-listing-msg" class="text-xs ml-2"></span>
      </div>
      {% endif %}

      {% else %}
      <p class="text-xs text-gray-500">No ASIN linked. Set an ASIN to enable Amazon listing and Keepa analysis.</p>
      {% endif %}
    </div>

    <!-- Keepa analysis -->
    {% if item.amazon_asin %}
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-900">Keepa Analysis</h2>
        <button hx-get="/partials/keepa-inline/{{ item.amazon_asin }}?cost_price={{ item.estimated_win_price or item.current_price }}&shipping_cost={{ item.shipping_cost }}"
                hx-target="#keepa-inline-result" hx-indicator="#keepa-spinner"
                class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">
          Analyze
          <span id="keepa-spinner" class="htmx-indicator spinner inline-block w-3 h-3 border-2 border-gray-300 border-t-blue-600 rounded-full ml-1"></span>
        </button>
      </div>
      <div id="keepa-inline-result">
        <p class="text-xs text-gray-500">Click "Analyze" to fetch Keepa data for {{ item.amazon_asin }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Tabs: History / Notifications -->
    <div class="bg-white rounded-lg shadow-sm border" x-data="{ tab: 'history' }">
      <div class="flex border-b">
        <button @click="tab = 'history'" :class="tab === 'history' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'"
                class="px-4 py-2 text-sm font-medium">History</button>
        <button @click="tab = 'notifications'" :class="tab === 'notifications' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'"
                class="px-4 py-2 text-sm font-medium">Notifications</button>
      </div>

      <!-- History tab -->
      <div x-show="tab === 'history'" class="p-4">
        <div class="space-y-2">
          {% for h in history %}
          <div class="flex items-center text-xs text-gray-600 gap-2">
            <span class="text-gray-400 w-32 flex-shrink-0">{{ h.recorded_at.strftime('%m/%d %H:%M') if h.recorded_at else '' }}</span>
            <span class="px-1.5 py-0.5 rounded bg-gray-100 font-medium">{{ h.change_type }}</span>
            {% if h.change_type == 'status_change' %}
            <span>{{ h.old_status }} &rarr; {{ h.new_status }}</span>
            {% elif h.change_type == 'price_change' %}
            <span>&yen;{{ "{:,}".format(h.old_price or 0) }} &rarr; &yen;{{ "{:,}".format(h.new_price or 0) }}</span>
            {% elif h.change_type == 'bid_change' %}
            <span>{{ h.old_bid_count or 0 }} &rarr; {{ h.new_bid_count or 0 }} bids</span>
            {% elif h.change_type == 'initial' %}
            <span>Monitoring started</span>
            {% endif %}
          </div>
          {% else %}
          <p class="text-xs text-gray-500">No history yet.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Notifications tab -->
      <div x-show="tab === 'notifications'" x-cloak class="p-4">
        <div class="space-y-2">
          {% for n in notifications %}
          <div class="flex items-center text-xs text-gray-600 gap-2">
            <span class="text-gray-400 w-32 flex-shrink-0">{{ n.sent_at.strftime('%m/%d %H:%M') if n.sent_at else '' }}</span>
            <span class="px-1.5 py-0.5 rounded font-medium
              {% if n.success %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-600{% endif %}">
              {{ n.channel }}
            </span>
            <span class="px-1.5 py-0.5 rounded bg-gray-100 font-medium">{{ n.event_type }}</span>
            <span class="truncate">{{ n.message }}</span>
          </div>
          {% else %}
          <p class="text-xs text-gray-500">No notifications yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar actions -->
  <div class="space-y-4">
    <div class="bg-white rounded-lg shadow-sm border p-4 space-y-3">
      <h2 class="text-sm font-semibold text-gray-900">Actions</h2>
      <button hx-post="/api/items/{{ item.auction_id }}/refresh" hx-swap="none"
              hx-on::after-request="if(event.detail.successful) window.location.reload()"
              class="w-full px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-md text-center">
        Refresh Data
      </button>
      <button onclick="toggleMonitoring()" id="monitor-toggle-btn"
              class="w-full px-3 py-2 text-sm rounded-md text-center
                {% if item.is_monitoring_active %}bg-yellow-50 text-yellow-700 hover:bg-yellow-100{% else %}bg-green-50 text-green-700 hover:bg-green-100{% endif %}">
        {{ "Pause Monitoring" if item.is_monitoring_active else "Resume Monitoring" }}
      </button>
      <button onclick="if(confirm('Delete this item and all its history?')) fetch('/api/items/{{ item.auction_id }}', {method:'DELETE'}).then(()=>window.location='/items')"
              class="w-full px-3 py-2 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded-md text-center">
        Delete
      </button>
    </div>

    <!-- Item settings -->
    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-2">Settings</h2>
      <form onsubmit="updateSettings(event)" class="space-y-2">
        <div>
          <label class="block text-xs text-gray-500 mb-0.5">Check Interval (sec)</label>
          <input type="number" id="set-interval" value="{{ item.check_interval_seconds }}" min="30"
                 class="w-full px-2 py-1 border rounded text-sm">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-0.5">Notes</label>
          <input type="text" id="set-notes" value="{{ item.notes }}"
                 class="w-full px-2 py-1 border rounded text-sm">
        </div>
        <button type="submit" class="w-full px-2 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">
          Save Settings
        </button>
        <div id="settings-msg" class="text-xs"></div>
      </form>
    </div>

    <div class="bg-white rounded-lg shadow-sm border p-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-2">Details</h2>
      <dl class="text-xs space-y-2">
        <div><dt class="text-gray-500">Auction ID</dt><dd class="font-mono">{{ item.auction_id }}</dd></div>
        <div><dt class="text-gray-500">Seller</dt><dd>{{ item.seller_id or "-" }}</dd></div>
        <div><dt class="text-gray-500">Category</dt><dd>{{ item.category_id or "-" }}</dd></div>
        <div><dt class="text-gray-500">End Time</dt><dd>{{ item.end_time.strftime('%Y-%m-%d %H:%M') if item.end_time else "-" }}</dd></div>
        <div><dt class="text-gray-500">Last Checked</dt><dd>{{ item.last_checked_at.strftime('%m/%d %H:%M') if item.last_checked_at else "-" }}</dd></div>
        <div><dt class="text-gray-500">Created</dt><dd>{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else "-" }}</dd></div>
      </dl>
    </div>
  </div>
</div>

<!-- Set ASIN dialog -->
<dialog id="asin-dialog" class="rounded-lg shadow-xl p-0 w-full max-w-sm backdrop:bg-gray-900/50">
  <form method="dialog" class="p-6">
    <h2 class="text-lg font-semibold mb-4">Set Amazon ASIN</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ASIN</label>
        <input type="text" id="asin-input" placeholder="B07WXL5YPW"
               class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Win Price</label>
        <input type="number" id="asin-win-price" value="{{ item.current_price }}"
               class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Shipping Cost</label>
        <input type="number" id="asin-shipping" value="{{ item.shipping_cost or 800 }}"
               class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-6">
      <button type="submit" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md">Cancel</button>
      <button type="button" onclick="setAsin()" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700">
        Save
      </button>
    </div>
    <div id="asin-error" class="mt-3 text-sm text-red-600 hidden"></div>
  </form>
</dialog>

<script>
const auctionId = '{{ item.auction_id }}';

async function setAsin() {
  const asin = document.getElementById('asin-input').value.trim();
  const winPrice = parseInt(document.getElementById('asin-win-price').value) || 0;
  const shipping = parseInt(document.getElementById('asin-shipping').value) || 800;
  const errEl = document.getElementById('asin-error');
  if (!asin) { errEl.textContent = 'ASIN is required'; errEl.classList.remove('hidden'); return; }
  try {
    const resp = await fetch('/api/items/' + auctionId, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });
    // Use direct DB update via a custom endpoint
    const resp2 = await fetch('/web/set-asin/' + auctionId, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({asin: asin, estimated_win_price: winPrice, shipping_cost: shipping})
    });
    if (!resp2.ok) { const d = await resp2.json(); throw new Error(d.detail || 'Failed'); }
    window.location.reload();
  } catch(e) {
    errEl.textContent = e.message; errEl.classList.remove('hidden');
  }
}

async function toggleMonitoring() {
  const btn = document.getElementById('monitor-toggle-btn');
  const isActive = btn.textContent.trim().startsWith('Pause');
  btn.disabled = true;
  try {
    const resp = await fetch('/api/items/' + auctionId, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({is_monitoring_active: !isActive})
    });
    if (!resp.ok) throw new Error('Failed');
    window.location.reload();
  } catch(e) { btn.disabled = false; }
}

async function updateSettings(e) {
  e.preventDefault();
  const interval = parseInt(document.getElementById('set-interval').value);
  const notes = document.getElementById('set-notes').value;
  const msgEl = document.getElementById('settings-msg');
  try {
    const resp = await fetch('/api/items/' + auctionId, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({check_interval_seconds: interval, notes: notes})
    });
    if (!resp.ok) throw new Error('Failed');
    msgEl.textContent = 'Saved'; msgEl.className = 'text-xs text-green-600';
  } catch(e) {
    msgEl.textContent = e.message; msgEl.className = 'text-xs text-red-600';
  }
}

async function createAmazonListing() {
  const btn = document.getElementById('create-listing-btn');
  const msgEl = document.getElementById('create-listing-msg');
  btn.disabled = true; btn.textContent = 'Creating...';
  try {
    const resp = await fetch('/api/amazon/listings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({auction_id: auctionId, asin: '{{ item.amazon_asin or "" }}'})
    });
    if (!resp.ok) { const d = await resp.json(); throw new Error(d.detail || 'Failed'); }
    window.location.reload();
  } catch(e) {
    msgEl.textContent = e.message; msgEl.className = 'text-xs text-red-600';
    btn.disabled = false; btn.textContent = 'Create Amazon Listing';
  }
}
</script>
{% endblock %}
